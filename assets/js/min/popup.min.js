$(document).ready((function(){chrome.storage.local.get(["options"],(function(e){null!=e.options&&1==e.options.darkMode&&$("body").addClass("dark")})),chrome.storage.local.get(["personalInfo"],(function(e){null==e.personalInfo&&$(".js-first-page").removeClass("hidden")})),$(".js-position-checkbox").change((function(){$(this).is(":checked")?($(".position-test").addClass("active"),$(".position-dev").removeClass("active")):($(".position-dev").addClass("active"),$(".position-test").removeClass("active"))}));var e,t,s,a=$(".js-displayed-team-name").text();function n(e,t,s){var a={position:e,teamsName:t,sprintWeeks:s};chrome.storage.local.set({personalInfo:a});chrome.storage.local.set({tasks:{current:{anyCurrent:!1},oldTasks:[],lastTaskId:0}},(function(){$(".js-first-page").addClass("hidden"),$(".js-work-content").removeClass("hidden"),r()}))}function r(){chrome.storage.local.get(["tasks"],(function(e){null!=e.tasks&&($(".js-work-content").removeClass("hidden"),0==e.tasks.lastTaskId?($(".js-noTask").removeClass("hidden"),$(".js-hasTask").addClass("hidden")):e.tasks.lastTaskId>0&&$(".js-footer").removeClass("hidden"),e.tasks.oldTasks.length>1&&$(".js-previousTasksText").removeClass("hidden"))}))}function o(){chrome.storage.local.get(["tasks"],(function(e){allTasks=e.tasks,i(allTasks)}))}function i(e){$(".js-previousTasks").empty();var t=(new Date).getTime(),s="";if(null!=e){var a=e.current.id-1;e.current.anyCurrent?(timer=t-e.current.date,e.current.totalSpended>0&&(timer+=e.current.totalSpended),timer=d(timer),timer=timer.split(":"),parseInt(timer[0])>0&&(parseInt(timer[0])<10&&(timer[0]=timer[0].toString().substring(1)),$(".js-currentTask-time-hour").text(timer[0]+" Hour(s) and")),$(".js-currentTask-time-min").text(timer[1]+" minute(s)"),$(".js-currentTask-name").text(e.current.name),$(".js-has-working-task").removeClass("hidden"),$(".js-no-working-task").addClass("hidden")):($(".js-has-working-task").addClass("hidden"),$(".js-no-working-task").removeClass("hidden"));for(var n=0;n<e.oldTasks.length;n++)e.current.anyCurrent&&a==n||e.oldTasks[n].removed||(timer=d(e.oldTasks[n].totalSpended),s+='<div class="inactiveTask" data-id="'+e.oldTasks[n].id+'"> <span class="inactiveTaskName">',s+=e.oldTasks[n].name+' - </span> <span class="inactiveTaskDate">',s+=timer+'</span> <span class="launchTask js-launchTask"> <img src="../assets/icons/launch.png" title="Start working on this task"> </span>',s+='<span class="removeOldTask js-removeOldTask" data-id="'+e.oldTasks[n].id+'">  <img src="../assets/icons/remove.png" title="Remove this task">  </span>',s+="</div>");$(".js-previousTasks").append(s)}}function d(e){var t=Math.floor(e/6e4%60),s=Math.floor(e/36e5).toFixed(0);return(s<10?"0":"")+s+":"+(t<10?"0":"")+t}function c(e,t){var s=(new Date).getTime();if(e.current.anyCurrent){if(e.current.id==e.lastTaskId&&e.oldTasks.findIndex(e=>e.id===t)<0){var a={id:e.current.id,name:e.current.name,date:e.current.date,totalSpended:s-e.current.date,removed:!1};e.oldTasks.push(a)}else{var n=s-e.current.date;e.oldTasks[t-1].totalSpended+=n}e.current.anyCurrent=!1,chrome.storage.local.set({tasks:e},(function(){o()}))}}function l(){chrome.storage.local.get(["tasks"],(function(e){null!=e.tasks&&function(e){if(null!=e.tasks){var t=(new Date).getTime();timePass=t-e.tasks.current.date+e.tasks.current.totalSpended;var s=Math.floor(timePass/6e4%60),a=Math.floor(timePass/36e5).toFixed(0);s<10&&(s="0"+s),e.tasks.current.anyCurrent?chrome.browserAction.setBadgeText({text:a+":"+s}):chrome.browserAction.setBadgeText({text:""})}}(e)}))}function u(e){$(".js-resetSprint").removeClass("hidden"),$(".js-exportSprint").removeClass("hidden"),$(".resetConfirmation").addClass("hidden"),e&&$(".js-footer").addClass("hidden")}$(".js-team-name").keyup((function(){$(".js-displayed-team-name").text(a+$(this).val())})),e=0,t="",s="",$(".js-save-info").click((function(){$(".js-position-checkbox").is(":checked")&&(e=1),$(".js-team-name").val().length>0&&(t=$(".js-team-name").val()),document.querySelector('input[name="rb"]:checked')&&(s=parseInt(document.querySelector('input[name="rb"]:checked').value)),n(e,t,s)})),$(".js-skip-info").click((function(){n("","","")})),r(),chrome.storage.onChanged.addListener((function(e){if(null!=e.tasks){var t=e.tasks.newValue;t.current.anyCurrent?i(t):($(".js-has-working-task").addClass("hidden"),$(".js-no-working-task").removeClass("hidden"))}})),o(),$(document).on("click",".js-launchTask",(function(){var e=$(this).parent().data("id");chrome.storage.local.get(["tasks"],(function(t){allTasks=t.tasks,e-=1,c(allTasks,e),function(e,t){var s=(new Date).getTime();e.current.anyCurrent=!0,e.current.id=e.oldTasks[t].id,e.current.name=e.oldTasks[t].name,e.current.date=s,e.current.totalSpended=e.oldTasks[t].totalSpended,chrome.storage.local.set({tasks:e},(function(){o()}))}(allTasks,e),l()})),r()})),$(document).on("click",".js-currentTaskMission",(function(){chrome.storage.local.get(["tasks"],(function(e){c(e.tasks,e.tasks.current.id),l(),r()}))})),window.setInterval((function(){o()}),6e4),l(),$(".js-resetSprint").click((function(){$(".js-resetSprint").addClass("hidden"),$(".js-exportSprint").addClass("hidden"),$(".resetConfirmation").removeClass("hidden"),setTimeout((function(){u(!1)}),3e3)})),$(".js-resetConfirmation").click((function(){chrome.storage.local.set({tasks:{current:{anyCurrent:!1},oldTasks:[],lastTaskId:0}},(function(){r(),u(!0)}))})),$(".js-cancelReset").click((function(){u(!1)})),$(".js-exportSprint").click((function(){var e=(new Date).getTime(),t=[["Task Name","Task Time(hr:min)"]];chrome.storage.local.get(["tasks"],(function(s){if(s.tasks.current.anyCurrent){timer=e-s.tasks.current.date,timer=d(timer);var a=[s.tasks.current.name,timer];t.push(a)}for(var n=0;n<s.tasks.oldTasks.length;n++){crnttime=d(s.tasks.oldTasks[n].totalSpended);var r=[s.tasks.oldTasks[n].name,crnttime];t.push(r)}!function(e,t){for(var s=function(e){for(var t="",s=0;s<e.length;s++){var a=null===e[s]?"":e[s].toString();e[s]instanceof Date&&(a=e[s].toLocaleString());var n=a.replace(/"/g,'""');n.search(/("|,|\n)/g)>=0&&(n='"'+n+'"'),s>0&&(t+=","),t+=n}return t+"\n"},a="",n=0;n<t.length;n++)a+=s(t[n]);var r=new Blob([a],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a");if(void 0!==o.download){var i=URL.createObjectURL(r);o.setAttribute("href",i),o.setAttribute("download",e),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}("sprint-tasks.csv",t)}))})),$(document).on("click",".js-removeOldTask",(function(){var e=$(this).data("id");chrome.storage.local.get(["tasks"],(function(t){var s=t.tasks,a=s.oldTasks.findIndex(t=>t.id===e);s.oldTasks[a].removed=!0,chrome.storage.local.set({tasks:s},(function(){}))})),o()}))}));